# ModSecurity Configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecAuditEngine RelevantOnly
SecAuditLog /var/log/nginx/modsec_audit.log
SecAuditLogParts ABIJDEFHZ

# Debug: Log all Origin headers to see what we're getting
SecRule REQUEST_HEADERS:Origin ".*" "phase:1,pass,id:999888777,log,msg:'Origin header detected: %{MATCHED_VAR}'"

# Method 1: Allow based on multiple possible headers (Origin, Referer, Host)
SecRule REQUEST_HEADERS:Origin "@contains mysafespace.technosmart247.co.za" "phase:1,pass,id:381729564829,skip:10"
SecRule REQUEST_HEADERS:Referer "@contains mysafespace.technosmart247.co.za" "phase:1,pass,id:381729564830,skip:9"
SecRule REQUEST_HEADERS:Host "@streq mysafespace.technosmart247.co.za" "phase:1,pass,id:381729564831,skip:8"

# Allow specific paths
SecRule REQUEST_URI "^/admin" "phase:1,pass,id:847392516384,skip:7"
SecRule REQUEST_URI "^/api/v1" "phase:1,pass,id:291756849273,skip:6"
SecRule REQUEST_URI "^/media" "phase:1,pass,id:638471952847,skip:5"
SecRule REQUEST_URI "^/static" "phase:1,pass,id:529384761529,skip:4"
SecRule REQUEST_URI "^/o" "phase:1,pass,id:174635928471,skip:3"
SecRule REQUEST_URI "^/accounts" "phase:1,pass,id:492817364859,skip:2"
SecRule REQUEST_URI "^/api-docs" "phase:1,pass,id:756291483726,skip:1"

# Block root path (this will be skipped if any of the above match)
SecRule REQUEST_URI "^/$" "phase:1,deny,status:403,id:654238917364,msg:'Blocking root path - Origin: %{REQUEST_HEADERS.origin}, Referer: %{REQUEST_HEADERS.referer}, Host: %{REQUEST_HEADERS.host}'"
